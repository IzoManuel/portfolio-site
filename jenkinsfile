pipeline {
  agent any

  stages {
    stage('Clone Repository') {
      steps {
        git url: 'git@github.com:IzoManuel/portfolio-site.git', credentialsId: '21701bdd-7c41-4204-9974-db5e390c2cf9'
      }
    }

    stage('Echo Stage') {
      steps {
        echo 'Building the portfolio site...'
      }
    }

    stage('Deploy') {
      steps {
        sshagent(['deploy-ssh-key']) {
          sh """
            set -x
            echo "Before copying files:"
            ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ubuntu@13.235.51.44 'ls -l /usr/share/nginx/html/'
          """
          sh """
            scp -i ~/.ssh/key.pem -o StrictHostKeyChecking=no -r * ubuntu@13.235.51.44:/home/ubuntu/portfolio-site
          """
          sh """
            ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ubuntu@13.235.51.44 'bash /home/ubuntu/portfolio-site/deploy.sh'
          """
          sh """
            set -x
            echo "After copying files:"
            ssh -i ~/.ssh/key.pem -o StrictHostKeyChecking=no ubuntu@13.235.51.44 'ls -l /usr/share/nginx/html/'
          """
        }
      }
    }
  }
}
